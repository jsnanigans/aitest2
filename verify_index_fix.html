<!DOCTYPE html>
<html>
<head>
    <title>Verify Index Fix</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .test-container { display: flex; gap: 20px; }
        .test-panel { flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        iframe { width: 100%; height: 600px; border: 2px solid #333; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Index Dashboard Viewer - Fix Verification</h1>
    
    <div class="test-container">
        <div class="test-panel">
            <h2>Test Controls</h2>
            <button onclick="testDataStructure()">1. Test Data Structure</button>
            <button onclick="testUserSelection()">2. Test User Selection</button>
            <button onclick="testDashboardLoad()">3. Test Dashboard Load</button>
            <button onclick="runAllTests()">Run All Tests</button>
            
            <div id="results"></div>
        </div>
        
        <div class="test-panel">
            <h2>Console Output</h2>
            <pre id="console"></pre>
        </div>
    </div>
    
    <h2>Live Index Viewer</h2>
    <iframe src="test_index_output/viz_test_no_date/index.html" id="indexFrame"></iframe>
    
    <script>
        const log = (msg, type = 'info') => {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `[${timestamp}] ${msg}\n`;
            console.scrollTop = console.scrollHeight;
        };
        
        const addResult = (msg, success = true) => {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${success ? 'success' : 'error'}`;
            div.textContent = msg;
            results.appendChild(div);
        };
        
        function getIframeWindow() {
            return document.getElementById('indexFrame').contentWindow;
        }
        
        function testDataStructure() {
            log('Testing data structure...');
            const iframeWindow = getIframeWindow();
            
            if (!iframeWindow.DASHBOARD_DATA) {
                addResult('✗ DASHBOARD_DATA not found', false);
                return false;
            }
            
            const data = iframeWindow.DASHBOARD_DATA;
            log(`Found ${data.users.length} users`);
            
            let allHaveDashboards = true;
            data.users.forEach(user => {
                log(`User ${user.id}: dashboard_file = ${user.dashboard_file}`);
                if (!user.dashboard_file) {
                    allHaveDashboards = false;
                }
            });
            
            if (allHaveDashboards) {
                addResult('✓ All users have dashboard files');
            } else {
                addResult('✗ Some users missing dashboard files', false);
            }
            
            return allHaveDashboards;
        }
        
        function testUserSelection() {
            log('Testing user selection...');
            const iframeWindow = getIframeWindow();
            
            if (!iframeWindow.viewer) {
                addResult('✗ Viewer not initialized', false);
                return false;
            }
            
            const viewer = iframeWindow.viewer;
            const firstUser = viewer.filteredUsers[0];
            
            if (!firstUser) {
                addResult('✗ No users available', false);
                return false;
            }
            
            log(`Selecting user: ${firstUser.id}`);
            log(`User object: ${JSON.stringify(firstUser, null, 2)}`);
            
            viewer.selectUser(firstUser);
            
            setTimeout(() => {
                if (viewer.currentUser && viewer.currentUser.id === firstUser.id) {
                    addResult(`✓ User ${firstUser.id} selected successfully`);
                    log(`Current user dashboard_file: ${viewer.currentUser.dashboard_file}`);
                } else {
                    addResult('✗ User selection failed', false);
                }
            }, 100);
            
            return true;
        }
        
        function testDashboardLoad() {
            log('Testing dashboard load...');
            const iframeWindow = getIframeWindow();
            
            if (!iframeWindow.viewer || !iframeWindow.viewer.currentUser) {
                addResult('✗ No user selected', false);
                return false;
            }
            
            const dashboardContainer = iframeWindow.document.getElementById('dashboardContainer');
            const iframe = dashboardContainer.querySelector('iframe');
            
            if (iframe) {
                log(`Dashboard iframe src: ${iframe.src}`);
                addResult('✓ Dashboard iframe created');
                
                // Check if it's actually loading
                if (iframe.src.includes('.html')) {
                    addResult('✓ Dashboard URL looks correct');
                } else {
                    addResult('✗ Dashboard URL seems wrong', false);
                }
            } else {
                const errorMsg = dashboardContainer.querySelector('.error-message');
                if (errorMsg) {
                    addResult(`✗ Error displayed: ${errorMsg.textContent}`, false);
                } else {
                    addResult('✗ No dashboard iframe found', false);
                }
            }
            
            return !!iframe;
        }
        
        async function runAllTests() {
            document.getElementById('results').innerHTML = '';
            log('Running all tests...');
            
            // Wait for iframe to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const test1 = testDataStructure();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const test2 = testUserSelection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const test3 = testDashboardLoad();
            
            if (test1 && test2 && test3) {
                addResult('✓ All tests passed!');
            } else {
                addResult('✗ Some tests failed', false);
            }
        }
        
        // Run tests when iframe loads
        window.onload = () => {
            const iframe = document.getElementById('indexFrame');
            iframe.onload = () => {
                log('Index viewer loaded');
                setTimeout(runAllTests, 1000);
            };
        };
    </script>
</body>
</html>